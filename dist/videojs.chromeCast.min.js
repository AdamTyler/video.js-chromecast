/*! videojs-chromeCast - v0.1.0 - 2014-02-12
* https://github.com/benjipott/videojs-chromeCast
* Copyright (c) 2014 Pott Benjamin; Licensed MIT */

vjs.plugin.merge=function(){var a=vjs.obj.merge.apply(this,arguments);if(a.hasOwnProperty("userAgentAllowed")&&a.enabled){a.userAgentAllowed=a.userAgentAllowed.split(",");for(var b=0,c=a.userAgentAllowed;b<c.length;b++){var d=new RegExp(c[b],"i");if(a.enabled=!!vjs.USER_AGENT.match(d),a.enabled)break}}return a},function(){var a={enabled:!0,appId:"your_app_id",namespace:"",title:"",description:""};vjs.plugin("chromecast",function(b){var c=vjs.plugin.merge(a,b);return c.enabled?(this.player=this,this.chromeCastComponent=new vjs.ChromeCastComponent(this,c),this.player.controlBar.addChild(this.chromeCastComponent),void 0):!1})}();var cast=cast||{};vjs.Player.prototype.chromeCastComponent={},vjs.ChromeCastComponent=vjs.Button.extend({init:function(a,b){vjs.Button.call(this,a,b),vjs.log(this.player_),a.controls()||this.disable(),this.hide(),this.el_.setAttribute("role","button"),this.initializeApi()}}),vjs.ChromeCastComponent.prototype.kind_="chromecast",vjs.ChromeCastComponent.prototype.buttonText="Chromecast",vjs.ChromeCastComponent.prototype.className="vjs-chromecast-button ",vjs.ChromeCastComponent.prototype.chromeCastBanner={},vjs.ChromeCastComponent.prototype.apiMedia=null,vjs.ChromeCastComponent.prototype.apiSession=null,vjs.ChromeCastComponent.prototype.apiInitialized=!1,vjs.ChromeCastComponent.prototype.progressFlag=1,vjs.ChromeCastComponent.prototype.timer=null,vjs.ChromeCastComponent.prototype.timerStep=1e3,vjs.ChromeCastComponent.prototype.currentMediaTime=0,vjs.ChromeCastComponent.prototype.playing=!1,vjs.ChromeCastComponent.prototype.onInitSuccess=function(){vjs.log("api_status :Initialized"),this.apiInitialized=!0},vjs.ChromeCastComponent.prototype.onInitError=function(a){vjs.log("Initialize Error: "+JSON.stringify(a))},vjs.ChromeCastComponent.prototype.sessionJoinedListener=function(a){vjs.log("Joined "+a.sessionId)},vjs.ChromeCastComponent.prototype.sessionUpdateListener=function(){},vjs.ChromeCastComponent.prototype.receiverListener=function(a){vjs.log("receivers available: "+("available"===a?"Yes":"No")),"available"===a&&this.show()},vjs.ChromeCastComponent.prototype.initializeApi=function(){if(vjs.log("ChromeCastComponent initializeApi"),vjs.IS_CHROME){if(!chrome.cast||!chrome.cast.isAvailable)return vjs.log("Cast APIs not Available. Retrying..."),setTimeout(this.initializeApi.bind(this),1e3),void 0;var a=new chrome.cast.SessionRequest(this.options_.appId),b=new chrome.cast.ApiConfig(a,this.sessionJoinedListener.bind(this),this.receiverListener.bind(this));chrome.cast.initialize(b,this.onInitSuccess.bind(this),this.onInitError.bind(this))}},vjs.ChromeCastComponent.prototype.doLaunch=function(){vjs.log("Cast video : "+this.player_.currentSrc()),this.apiInitialized?chrome.cast.requestSession(this.onSessionSuccess.bind(this),function(a){vjs.log("session_established ERROR: "+JSON.stringify(a))}):vjs.log("session_established NOT INITIALIZED")},vjs.ChromeCastComponent.prototype.onSessionSuccess=function(a){this.apiSession=a,vjs.log("session_established YES - "+a.sessionId),this.addClass("connected"),this.player_.pause(),this.player_.chromeCastComponent.disableNativeControls();var b=new chrome.cast.media.MediaInfo(this.player_.currentSrc(),"video/mp4"),c=new chrome.cast.media.LoadRequest(b);c.autoplay=!0,vjs.log("Sending Load Request: "),vjs.log(c),this.apiSession.loadMedia(c,this.onMediaDiscovered.bind(this),this.onMediaError.bind(this))},vjs.ChromeCastComponent.prototype.onMediaDiscovered=function(a){this.apiMedia=a,this.apiMedia.addUpdateListener(this.onMediaStatusUpdate.bind(this)),vjs.log("Got media object"),this.startProgressTimer(this.incrementMediaTime.bind(this)),vjs.log("play!!!!"),this.playing=!0,this.player_.controlBar.playToggle.onPlay(),this.player_.onPlay(),this.apiMedia.playerState===chrome.cast.media.PlayerState.PLAYING},vjs.ChromeCastComponent.prototype.onMediaError=function(a){vjs.log("Media Error: "+JSON.stringify(a))},vjs.ChromeCastComponent.prototype.onMediaStatusUpdate=function(){this.progressFlag&&vjs.log(this.apiMedia.currentTime+"/"+this.apiMedia.media.duration),vjs.log(this.apiMedia.playerState),vjs.ChromeCastComponent.prototype.currentMediaTime=this.apiMedia.currentTime},vjs.ChromeCastComponent.prototype.startProgressTimer=function(a){this.timer&&(clearInterval(this.timer),this.timer=null),vjs.log("starting timer..."),this.timer=setInterval(a.bind(this),this.timerStep)},vjs.ChromeCastComponent.prototype.playMedia=function(){this.apiMedia&&(this.playing?(this.apiMedia.pause(null,this.mediaCommandSuccessCallback.bind(this,"paused "+this.apiMedia.sessionId),this.onError.bind(this)),this.player_.controlBar.playToggle.onPause(),this.player_.onPause(),this.playing=!1):(this.apiMedia.play(null,this.mediaCommandSuccessCallback.bind(this,"playing started for "+this.apiMedia.sessionId),this.onError.bind(this)),this.apiMedia.addUpdateListener(this.onMediaStatusUpdate.bind(this)),this.player_.controlBar.playToggle.onPlay(),this.player_.onPlay(),this.playing=!0))},vjs.ChromeCastComponent.prototype.incrementMediaTime=function(){this.apiMedia.playerState===chrome.cast.media.PlayerState.PLAYING&&(this.currentMediaTime<this.apiMedia.media.duration?(this.currentMediaTime+=1,this.updateProgressBarByTimer()):(this.currentMediaTime=0,clearInterval(this.timer)))},vjs.ChromeCastComponent.prototype.updateProgressBarByTimer=function(){var a=parseInt(100*this.currentMediaTime/this.apiMedia.media.duration);this.player_.controlBar.progressControl.seekBar.bar.el_.style&&(this.player_.controlBar.progressControl.seekBar.bar.el_.style.width=vjs.round(a,2)+"%"),this.player_.controlBar.progressControl.seekBar.seekHandle.el_.style&&(this.player_.controlBar.progressControl.seekBar.seekHandle.el_.style.left=vjs.round(a,2)+"%"),this.player_.controlBar.currentTimeDisplay.content.innerHTML='<span class="vjs-control-text">Current Time </span>'+vjs.formatTime(this.currentMediaTime)},vjs.ChromeCastComponent.prototype.mediaCommandSuccessCallback=function(a){vjs.log(a)},vjs.ChromeCastComponent.prototype.onError=function(){vjs.log("error")},vjs.ChromeCastComponent.prototype.disableNativeControls=function(){this.player_.pause(),this.player_.posterImage.off("click"),this.player_.posterImage.show(),this.player_.controlBar.progressControl.seekBar.off("mousedown"),this.player_.controlBar.progressControl.seekBar.off("touchstart"),this.player_.controlBar.progressControl.seekBar.off("click"),this.player_.controlBar.playToggle.off("click"),this.player_.controlBar.playToggle.off("focus"),this.player_.controlBar.playToggle.off("blur"),this.player_.controlBar.playToggle.on("click",this.playMedia.bind(this))},vjs.ChromeCastComponent.prototype.enableNativeControls=function(){this.player_.controlBar.progressControl.seekBar.on("mousedown",player.controlBar.progressControl.seekBar.onMouseDown),this.player_.controlBar.progressControl.seekBar.on("touchstart",player.controlBar.progressControl.seekBar.onMouseDown),this.player_.controlBar.progressControl.seekBar.on("click",player.controlBar.progressControl.seekBar.onClick)},vjs.ChromeCastComponent.prototype.buildCSSClass=function(){return this.className+vjs.Button.prototype.buildCSSClass.call(this)},vjs.ChromeCastComponent.prototype.createEl=function(){var a=vjs.Button.prototype.createEl.call(this,"div");return a},vjs.ChromeCastComponent.prototype.onClick=function(){vjs.Button.prototype.onClick.call(this),this.doLaunch()},vjs.ChromeCastBanner=vjs.Component.extend({init:function(a,b){vjs.Component.call(this,a,b)}}),vjs.ChromeCastBanner.prototype.createEl=function(a,b){return b=vjs.obj.merge({className:this.buildCSSClass(),innerHTML:"",tabIndex:0},b),vjs.Component.prototype.createEl.call(this,a,b)},vjs.ChromeCastBanner.prototype.buildCSSClass=function(){return"vjs-currentlyCasting"};